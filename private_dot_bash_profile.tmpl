##############################################################################
#  bash_profile — managed by chezmoi
##############################################################################
#  Sections:
#    1. Homebrew
#    2. Languages (Go, Rust)
#    3. Tools (mise, direnv, 1Password)
#    4. Completions
#    5. Kubernetes
#    6. Aliases
#    7. Colors & Prompt
#    8. Machine-Specific ({{ .machine_type }})
##############################################################################

## ── 1. Homebrew ─────────────────────────────────────────────────────────
{{- if eq .chezmoi.os "darwin" }}
if [[ $(uname -m) == 'arm64' ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{- end }}


## ── 2. Languages ────────────────────────────────────────────────────────

## Go
export GOPATH="${HOME}/.go"
export GOROOT="$(brew --prefix go)/libexec"
export PATH="$PATH:$(go env GOPATH)/bin"
export GO111MODULE=""
export GOPROXY="https://proxy.golang.org,direct"
export GOSUMDB="sum.golang.org"

## Rust
export RUSTUP_HOME="$HOME/.rustup"
export CARGO_HOME="$HOME/.cargo"
. "$HOME/.cargo/env"
export PATH="$PATH:${HOME}/.cargo/bin"
export PATH="$PATH:$(brew --prefix rustup)/bin"


## ── 3. Tools ────────────────────────────────────────────────────────────

## mise — https://mise.jdx.dev
eval "$(/opt/homebrew/bin/mise activate bash)"

## direnv
eval "$(direnv hook bash)"

## 1Password CLI completion
source <(op completion bash)


## ── 4. Completions ──────────────────────────────────────────────────────

[ -f /usr/local/etc/bash_completion ] && . /usr/local/etc/bash_completion
[[ -r "/opt/homebrew/etc/profile.d/bash_completion.sh" ]] && . "/opt/homebrew/etc/profile.d/bash_completion.sh"

## iTerm2 integration
test -e "${HOME}/.iterm2_shell_integration.bash" && source "${HOME}/.iterm2_shell_integration.bash" || true
if [ $ITERM_SESSION_ID ]; then
  export PROMPT_COMMAND='echo -ne "\033]0;${PWD##*/}\007"';
fi


## ── 5. Kubernetes ───────────────────────────────────────────────────────

## kube-ps1 (PS1 integration is in section 7)
if [[ $(uname -m) == 'x86_64' ]]; then
  source "/usr/local/opt/kube-ps1/share/kube-ps1.sh"
elif [[ $(uname -m) == 'arm64' ]]; then
  source "/opt/homebrew/opt/kube-ps1/share/kube-ps1.sh"
fi

export KUBE_EDITOR="nano"
export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"


## ── 6. Aliases ──────────────────────────────────────────────────────────

alias aliases="alias | sed 's/=.*//'"
alias yarn-check="yarn global upgrade-interactive --latest"
alias glog="git log --pretty=oneline --abbrev-commit"
alias reload="source ~/.bash_profile"
alias k="kubectl"
alias ls='ls -GFh'

## chezmoi drift detection
alias dotdiff="chezmoi diff"
alias dotstat="chezmoi status"
alias dotsync="chezmoi git pull -- --autostash --rebase && chezmoi apply -v"

## colorize help output with bat
help() {
    "$@" --help 2>&1 | bat --plain --language=help
}
alias bathelp='bat -plhelp --paging=never'

## Load .bashrc if it exists
test -f ~/.bashrc && source ~/.bashrc

## Extend auto-completion to aliases
complete -F __start_kubectl k


## ── 7. Colors & Prompt ──────────────────────────────────────────────────

export CLICOLOR=1
export LSCOLORS=ExFxBxDxCxegedabagacad

## @username:cwd$
export PS1="@\[\033[36m\]\u\[\033[m\]:\[\033[33;1m\]\W\[\033[m\]\$ "

## kube-ps1 in prompt
{{- if eq .machine_type "work" }}
function get_cluster_short() {
  echo $CLUSTER_NAME
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
{{- end }}
KUBE_PS1_CTX_COLOR='magenta'
PS1=$PS1'$(kube_ps1) '


## ── 8. Machine-Specific ({{ .machine_type }}) ──────────────────────────
{{- if eq .machine_type "personal" }}
alias tailscale="/Applications/Tailscale.app/Contents/MacOS/Tailscale"
alias docker="podman"
{{- else if eq .machine_type "work" }}
alias nextup="~/Documents/GitHub/nextup/target/release/nextup --names $HOME/Documents/GitHub/nextup/team.txt"
alias tvpn="$HOME/Documents/Workspace/tgpvpn-script/tvpn.sh"
{{- end }}
